services:
  emqx:
    image: emqx/emqx:5.7.2
    container_name: emqx_windfarm
    restart: unless-stopped
    ports:
      - "1883:1883"     # MQTT (sin TLS)
      - "8883:8883"     # MQTT (TLS)
      - "8083:8083"     # MQTT sobre WebSocket (sin TLS)
      - "8084:8084"     # MQTT sobre WebSocket (TLS)
      - "18083:18083"   # Dashboard web
    volumes:
       - ./EMQX/data:/opt/emqx/data
    networks:
      - windfarm_net

  # auth_node:
  #     build: 
  #       context: ./AuthNode   # carpeta base del proyecto Flask
  #       dockerfile: Dockerfile
  #     container_name: flask_api_auth
  #     ports:
  #       - "5000:5000" 
  #     environment:
  #       - FLASK_APP=server.py
  #       - FLASK_ENV=development

  mongo:
    image: mongo:latest
    container_name: mongo_windfarm
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - windfarm_net

  simulator:
    build:
      context: .
      dockerfile: python.Dockerfile
    container_name: windfarm_simulator
    command: python -m TurbineTelemetry.main
    depends_on:
      - emqx
    environment:
      # El host del broker es el nombre del servicio 'emqx'
      - MQTT_BROKER_HOST=emqx
    networks:
      - windfarm_net

  statnode:
    build:
      context: ./StatNode # .
      dockerfile: Dockerfile #python.Dockerfile
    container_name: windfarm_statnode
    #command: python -m StatNode.main # Usaremos un nuevo main.py
    depends_on:
      - emqx
      - mongo
    environment:
      # El host del broker es el nombre del servicio 'emqx'
      - MQTT_BROKER_HOST=emqx
      # La URI de mongo apunta al servicio 'mongo'
      - MONGO_URI=mongodb://mongo:27017
      - FLASK_APP=API.server
      - FLASK_ENV=development
    ports:
      - "5000:5000" # API Flask
    networks:
      - windfarm_net
    env_file:
      - ./StatNode/.env # fichero con las API keys
      

  # frontend_debugger:
  #   build:
  #     context: ./FrontendNode # Apuntamos al directorio del frontend
  #     dockerfile: Dockerfile # Asumimos/creamos un Dockerfile aqu√≠
  #   container_name: windfarm_frontend_debugger
  #   # El comando ahora instala dependencias y corre el dev server
  #   command: sh -c "npm install && npm run dev"
  #   ports:
  #     - "8080:8080" # Exponemos el puerto 8080 definido en vite.config.ts
  #   networks:
  #     - windfarm_net
  frontend_debugger:
    build:
      context: ./FrontendNode
      dockerfile: Dockerfile
    container_name: windfarm_frontend_debugger
    ports:
      - "8080:8080"
    networks:
      - windfarm_net


networks:
  windfarm_net:
    driver: bridge

volumes:
  mongo_data: