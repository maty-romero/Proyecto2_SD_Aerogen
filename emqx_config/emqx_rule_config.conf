rule_engine {
  ignore_sys_message = true
  jq_function_default_timeout = "10s"
  rules {
    rule_bearing_temperature {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = "${.}"
            qos = "1"
            retain = false
            topic = "farms/${farm_id}/alerts/turbines/${turbine_id}"
            user_properties = ""
          }
          function = republish
        }
      ]
      description = "Rule to detect high bearing temperature"
      enable = true
      metadata {created_at = 1762296497770}
      name = "rule_bearing_temperature"
      sql = """
        SELECT
          payload.farm_id AS farm_id,
          payload.turbine_id AS turbine_id,
          payload.farm_name AS farm_name,
          payload.turbine_name AS turbine_name,
          payload.bearing_temperature_c AS bearing_temperature_c,
          payload.timestamp AS timestamp,
          'Bearing temperature in critical levels' AS message
        FROM "farms/+/turbines/+/raw_telemetry"
        WHERE payload.bearing_temperature_c > 90
        """
    }
    rule_gear_temperature {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = "${.}"
            qos = 1
            retain = false
            topic = "farms/${farm_id}/alerts/turbines/${turbine_id}"
            user_properties = ""
          }
          function = republish
        }
      ]
      description = "Rule to detect high gear temperature"
      enable = true
      metadata {created_at = 1762295635867}
      name = "rule_gear_temperature"
      sql = """
        SELECT
          payload.farm_id AS farm_id,
          payload.turbine_id AS turbine_id,
          payload.farm_name AS farm_name,
          payload.turbine_name AS turbine_name,
          payload.gear_temperature_c AS gear_temperature_c,
          payload.timestamp AS timestamp,
          'Gear temperature in critical levels' as message
        FROM "farms/+/turbines/+/raw_telemetry"
        WHERE payload.gear_temperature_c > 100
        """
    }
    rule_noisy_telemetry {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = "${.}"
            qos = 1
            retain = false
            topic = "farms/${farm_id}/turbines/${turbine_id}/clean_telemetry"
            user_properties = ""
          }
          function = republish
        }
      ]
      description = "Rule to filter noisy telemetry data"
      enable = true
      metadata {created_at = 1762530126559}
      name = "rule_noisy_telemetry"
      sql = """
        SELECT
          payload.farm_id                     AS farm_id,
          payload.farm_name                    AS farm_name,
          payload.turbine_id                   AS turbine_id,
          payload.turbine_name                 AS turbine_name,
          payload.timestamp                    AS timestamp,
          payload.wind_speed_mps               AS wind_speed_mps,
          payload.wind_direction_deg           AS wind_direction_deg,
          payload.rotor_speed_rpm              AS rotor_speed_rpm,
          payload.blade_pitch_angle_deg        AS blade_pitch_angle_deg,
          payload.yaw_position_deg             AS yaw_position_deg,
          payload.vibrations_mms               AS vibrations_mms,
          payload.gear_temperature_c           AS gear_temperature_c,
          payload.bearing_temperature_c        AS bearing_temperature_c,
          payload.output_voltage_v             AS output_voltage_v,
          payload.generated_current_a          AS generated_current_a,
          payload.active_power_kw              AS active_power_kw,
          payload.reactive_power_kvar          AS reactive_power_kvar,
          payload.operational_state            AS operational_state,
          payload.capacity_mw                  AS capacity_mw
        FROM
          "farms/+/turbines/+/raw_telemetry"
        WHERE
          is_not_null_var(payload.wind_speed_mps)
          AND is_not_null_var(payload.rotor_speed_rpm)
          AND is_not_null_var(payload.bearing_temperature_c)
          AND payload.wind_speed_mps >= 0 AND payload.wind_speed_mps <= 60
          AND payload.rotor_speed_rpm >= 0 AND payload.rotor_speed_rpm <= 2000
          AND payload.bearing_temperature_c >= -10 AND payload.bearing_temperature_c <= 100
      """
    }
  }
}
