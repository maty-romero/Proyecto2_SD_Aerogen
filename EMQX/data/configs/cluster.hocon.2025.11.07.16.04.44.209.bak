authentication = []
authorization {
  cache {
    enable = true
    excludes = []
    max_size = 32
    ttl = "1m"
  }
  deny_action = ignore
  no_match = allow
  sources = [
    {
      enable = true
      path = "${EMQX_ETC_DIR}/acl.conf"
      type = file
    }
  ]
}
rule_engine {
  ignore_sys_message = true
  jq_function_default_timeout = "10s"
  rules {
    rule_bearing_temperature {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = ""
            qos = "1"
            retain = false
            topic = "farms/${farm_id}/alerts/turbines/${turbine_id}"
            user_properties = ""
          }
          function = republish
        }
      ]
      description = ""
      enable = true
      metadata {created_at = 1762296497770}
      name = ""
      sql = """~
        SELECT
          payload.farm_id AS farm_id,
          payload.turbine_id AS turbine_id,
          payload.farm_name AS farm_name,
          payload.turbine_name AS turbine_name,
          payload.bearing_temperature_c AS bearing_temperature_c,
          payload.timestamp AS timestamp,
          'Bearing temperature in critical levels' AS message
        FROM "farms/+/turbines/+/raw_telemetry"
        WHERE payload.bearing_temperature_c > 90~"""
    }
    rule_gear_temperature {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = ""
            qos = 1
            retain = false
            topic = "farms/${farm_id}/alerts/turbines/${turbine_id} "
            user_properties = ""
          }
          function = republish
        }
      ]
      description = ""
      enable = true
      metadata {created_at = 1762295635867}
      name = ""
      sql = """~
        SELECT
          payload.farm_id AS farm_id,
          payload.turbine_id AS turbine_id,
          payload.farm_name AS farm_name,
          payload.turbine_name AS turbine_name,
          payload.gear_temperature_c AS gear_temperature_c,
          payload.timestamp AS timestamp,
          'Gear temperature in critical levels' as message
        FROM "farms/+/turbines/+/raw_telemetry"
        WHERE payload.gear_temperature_c > 100~"""
    }
    rule_noisy_telemetry {
      actions = [
        {
          args {
            mqtt_properties {}
            payload = ""
            qos = "1"
            retain = false
            topic = "farms/${farm_id}/turbines/${turbine_id}/clean_telemetry"
            user_properties = ""
          }
          function = republish
        }
      ]
      description = ""
      metadata {created_at = 1762530126559}
      sql = """~
        SELECT
          payload
        FROM
          "farms/+/turbines/+/raw_telemetry"
        WHERE
          is_not_null_var(payload.wind_speed_mps)
          AND is_not_null_var(payload.rotor_speed_rpm)
          AND is_not_null_var(payload.bearing_temperature_c)
          AND payload.wind_speed_mps >= 0 AND payload.wind_speed_mps <= 60
          AND payload.rotor_speed_rpm >= 0 AND payload.rotor_speed_rpm <= 2000
          AND payload.bearing_temperature_c >= -10 AND payload.bearing_temperature_c <= 100
      ~"""
    }
  }
}
